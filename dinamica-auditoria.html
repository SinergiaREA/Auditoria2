<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta name="referrer" content="no-referrer">
<title>NIA 700 â€” EvaluaciÃ³n de AuditorÃ­a</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* â”€â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --ink:     #0d0d0d;
  --ink-60:  rgba(13,13,13,.6);
  --ink-20:  rgba(13,13,13,.12);
  --gold:    #c9a84c;
  --gold-lt: #f5e9c8;
  --cream:   #faf7f0;
  --white:   #ffffff;
  --emerald: #0f7b52;
  --ruby:    #c0392b;
  --sapphire:#1a5f9e;
  --amber:   #d97706;
  --r: 1rem;
}

/* â”€â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }

body {
  font-family:'DM Sans', sans-serif;
  background: var(--cream);
  color: var(--ink);
  min-height:100vh;
  overflow-x:hidden;
}

/* â”€â”€â”€ NOISE TEXTURE OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::before {
  content:'';
  position:fixed; inset:0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none; z-index:0;
}

/* â”€â”€â”€ GOLD ACCENT LINE TOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body::after {
  content:'';
  position:fixed; top:0; left:0; right:0;
  height:3px;
  background: linear-gradient(90deg, transparent, var(--gold) 20%, var(--gold) 80%, transparent);
  z-index:100;
}

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stage {
  position:relative; z-index:1;
  min-height:100vh;
  display:flex; align-items:center; justify-content:center;
  padding:60px 20px 80px;
}

.panel {
  width:100%; max-width:780px;
  background:var(--white);
  border:1px solid var(--ink-20);
  box-shadow: 0 2px 4px rgba(0,0,0,.04), 0 24px 64px rgba(0,0,0,.08), 0 0 0 1px rgba(201,168,76,.15);
  position:relative;
  overflow:hidden;
}

/* Corner ornaments */
.panel::before, .panel::after {
  content:'';
  position:absolute;
  width:40px; height:40px;
  border-color: var(--gold);
  border-style:solid;
  opacity:.5;
}
.panel::before { top:12px; left:12px; border-width:1px 0 0 1px; }
.panel::after  { bottom:12px; right:12px; border-width:0 1px 1px 0; }

.panel-inner { padding:56px 60px 60px; }

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.masthead {
  text-align:center;
  padding-bottom:40px;
  border-bottom:1px solid var(--ink-20);
  margin-bottom:40px;
  position:relative;
}
.masthead::after {
  content:'';
  position:absolute; bottom:-1px; left:50%; transform:translateX(-50%);
  width:60px; height:2px;
  background:var(--gold);
}

.eyebrow {
  font-family:'DM Mono', monospace;
  font-size:11px; /* âœï¸ TAMAÃ‘O: texto pequeÃ±o de categorÃ­a superior (ej. "ContadurÃ­a PÃºblica Â· AuditorÃ­a II") â€” recomendado: 10pxâ€“13px */
  font-weight:500;
  letter-spacing:3px;
  text-transform:uppercase;
  color:var(--gold);
  display:block;
  margin-bottom:20px;
}

.masthead-icon {
  font-size:52px; /* âœï¸ TAMAÃ‘O: emoji/Ã­cono principal de la pantalla de inicio y resultados â€” recomendado: 40pxâ€“70px */
  display:block;
  margin:0 auto 20px;
  filter:grayscale(.2);
  animation: float 4s ease-in-out infinite;
}
@keyframes float {
  0%,100% { transform:translateY(0); }
  50%      { transform:translateY(-8px); }
}

.masthead h1 {
  font-family:'Playfair Display', serif;
  font-size:clamp(28px,4vw,42px); /* âœï¸ TAMAÃ‘O: tÃ­tulo principal "EvaluaciÃ³n sobre el Informe del Auditor" â€” mÃ­n. 28px en mÃ³vil, mÃ¡x. 42px en escritorio. Cambia los dos valores para ajustar el rango */
  font-weight:900;
  letter-spacing:-.5px;
  line-height:1.15;
  color:var(--ink);
  margin-bottom:10px;
}

.masthead h1 em {
  font-style:normal;
  color:var(--gold);
}

.masthead-subtitle {
  font-size:15px; /* âœï¸ TAMAÃ‘O: subtÃ­tulo "Norma Internacional de AuditorÃ­a 700" â€” recomendado: 13pxâ€“17px */
  color:var(--ink-60);
  font-weight:300;
  letter-spacing:.3px;
}

/* â”€â”€â”€ RULES CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rules {
  background:var(--cream);
  border:1px solid var(--ink-20);
  padding:28px 32px;
  margin-bottom:36px;
  position:relative;
}
.rules-title {
  font-family:'DM Mono', monospace;
  font-size:10px; /* âœï¸ TAMAÃ‘O: encabezado "CÃ³mo funciona" dentro del recuadro de instrucciones â€” recomendado: 9pxâ€“12px */
  letter-spacing:2px; text-transform:uppercase;
  color:var(--gold); margin-bottom:16px;
}
.rules-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px 24px;
}
.rule-item {
  display:flex; align-items:center; gap:10px;
  font-size:14px; /* âœï¸ TAMAÃ‘O: texto de cada instrucciÃ³n (ej. "14 preguntas de opciÃ³n mÃºltiple") â€” recomendado: 13pxâ€“16px */
  color:var(--ink-60);
}
.rule-item span:first-child { font-size:18px; /* âœï¸ TAMAÃ‘O: emoji/Ã­cono al lado de cada instrucciÃ³n â€” recomendado: 16pxâ€“22px */ flex-shrink:0; }

/* â”€â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field { margin-bottom:28px; }

.field-label {
  display:block;
  font-size:11px; /* âœï¸ TAMAÃ‘O: etiqueta "Tu nombre completo" encima del campo â€” recomendado: 10pxâ€“13px */
  font-weight:600;
  letter-spacing:2px; text-transform:uppercase;
  color:var(--ink-60);
  margin-bottom:10px;
}

.field-wrap { position:relative; }

.field-input {
  width:100%;
  background:transparent;
  border:none;
  border-bottom:2px solid var(--ink-20);
  padding:14px 14px 14px 0;
  font-family:'DM Sans', sans-serif;
  font-size:20px; /* âœï¸ TAMAÃ‘O: texto que escribe el estudiante en el campo del nombre â€” recomendado: 16pxâ€“24px */
  font-weight:500;
  color:var(--ink);
  transition:border-color .25s;
  outline:none;
}
.field-input::placeholder { color:var(--ink-20); font-weight:300; }
.field-input:focus { border-color:var(--ink); }
.field-input.err { border-color:var(--ruby); animation:shake .4s ease; }

.field-line {
  position:absolute; bottom:0; left:0;
  width:0; height:2px;
  background:var(--gold);
  transition:width .4s cubic-bezier(.4,0,.2,1);
}
.field-input:focus ~ .field-line { width:100%; }

.field-error {
  font-size:12px; /* âœï¸ TAMAÃ‘O: mensaje de error de validaciÃ³n del nombre â€” recomendado: 11pxâ€“14px */
  color:var(--ruby);
  margin-top:8px; display:none; font-weight:500;
}
.field-error.show { display:block; animation:fadeUp .3s ease; }

/* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-primary {
  display:block; width:100%;
  background:var(--ink);
  color:var(--white);
  border:none; cursor:pointer;
  font-family:'DM Sans', sans-serif;
  font-size:14px; /* âœï¸ TAMAÃ‘O: texto del botÃ³n "Comenzar evaluaciÃ³n â†’" â€” recomendado: 13pxâ€“16px */
  font-weight:600;
  letter-spacing:2px; text-transform:uppercase;
  padding:20px 40px;
  position:relative; overflow:hidden;
  transition:background .25s, transform .15s;
}
.btn-primary::before {
  content:'';
  position:absolute; inset:0;
  background:var(--gold);
  transform:translateX(-101%);
  transition:transform .35s cubic-bezier(.4,0,.2,1);
}
.btn-primary:hover { transform:translateY(-1px); }
.btn-primary:hover::before { transform:translateX(0); }
.btn-primary span { position:relative; z-index:1; }
.btn-primary:active { transform:translateY(1px); }

.btn-ghost {
  display:inline-flex; align-items:center; gap:8px;
  background:transparent;
  color:var(--ink);
  border:1px solid var(--ink-20);
  cursor:pointer;
  font-family:'DM Sans', sans-serif;
  font-size:13px; /* âœï¸ TAMAÃ‘O: botÃ³n secundario "â†© Reintentar" y "Siguiente â†’" â€” recomendado: 12pxâ€“15px */
  font-weight:500;
  letter-spacing:1px;
  padding:14px 24px;
  transition:all .2s;
}
.btn-ghost:hover {
  border-color:var(--ink);
  background:var(--ink);
  color:var(--white);
}

.btn-emerald {
  background:var(--emerald);
  color:var(--white);
  border:none; cursor:pointer;
  font-family:'DM Sans', sans-serif;
  font-size:13px; /* âœï¸ TAMAÃ‘O: botÃ³n "â¬‡ Descargar PDF" â€” recomendado: 12pxâ€“15px */
  font-weight:600;
  letter-spacing:1.5px; text-transform:uppercase;
  padding:14px 28px;
  transition:opacity .2s, transform .15s;
}
.btn-emerald:hover { opacity:.88; transform:translateY(-1px); }

.btn-row {
  display:flex; gap:12px; margin-top:32px; flex-wrap:wrap;
}

/* â”€â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-rail {
  height:2px; background:var(--ink-20);
  margin-bottom:40px; position:relative;
}
.progress-fill-bar {
  position:absolute; top:0; left:0; height:100%;
  background:var(--gold);
  transition:width .6s cubic-bezier(.4,0,.2,1);
}

.quiz-meta {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:8px;
}

.q-counter {
  font-family:'DM Mono', monospace;
  font-size:12px; /* âœï¸ TAMAÃ‘O: contador "01 / 14" en la parte superior del quiz â€” recomendado: 11pxâ€“14px */
  letter-spacing:1px;
  color:var(--ink-60);
}

.q-user {
  font-size:13px; /* âœï¸ TAMAÃ‘O: nombre del estudiante mostrado durante el quiz â€” recomendado: 12pxâ€“15px */
  color:var(--ink-60);
  font-weight:500;
}

/* â”€â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timer-wrap {
  display:flex; align-items:center; gap:8px;
  margin-bottom:32px;
}
.timer-ring {
  position:relative;
  width:48px; height:48px; flex-shrink:0;
}
.timer-ring svg { transform:rotate(-90deg); }
.timer-ring circle.track { fill:none; stroke:var(--ink-20); stroke-width:3; }
.timer-ring circle.fill  { fill:none; stroke:var(--gold); stroke-width:3;
  stroke-dasharray:125.6; stroke-dashoffset:0;
  transition:stroke-dashoffset .9s linear, stroke .3s;
  stroke-linecap:round; }
.timer-ring circle.fill.warn  { stroke:var(--amber); }
.timer-ring circle.fill.danger{ stroke:var(--ruby); }
.timer-num {
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-family:'DM Mono', monospace;
  font-size:13px; /* âœï¸ TAMAÃ‘O: nÃºmero de segundos dentro del cÃ­rculo del temporizador â€” recomendado: 11pxâ€“15px */
  font-weight:500;
  color:var(--ink);
}
.timer-label { font-size:13px; /* âœï¸ TAMAÃ‘O: texto "segundos restantes" junto al temporizador â€” recomendado: 12pxâ€“15px */ color:var(--ink-60); }
.streak-pill {
  margin-left:auto;
  background:var(--ink);
  color:var(--gold);
  font-family:'DM Mono', monospace;
  font-size:11px; /* âœï¸ TAMAÃ‘O: badge de racha "ğŸ”¥ Ã—3" en la esquina superior derecha del quiz â€” recomendado: 10pxâ€“13px */
  letter-spacing:1px;
  padding:6px 14px;
  display:none;
  animation:popIn .35s cubic-bezier(.34,1.56,.64,1);
}
.streak-pill.visible { display:inline-block; }

/* â”€â”€â”€ QUESTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.q-num {
  font-family:'DM Mono', monospace;
  font-size:11px; /* âœï¸ TAMAÃ‘O: etiqueta "Pregunta 1 de 14" en dorado sobre la pregunta â€” recomendado: 10pxâ€“13px */
  color:var(--gold);
  letter-spacing:2px; text-transform:uppercase;
  margin-bottom:12px;
}

.q-text {
  font-family:'Playfair Display', serif;
  font-size:clamp(18px,2.5vw,24px); /* âœï¸ TAMAÃ‘O: texto de la pregunta â€” mÃ­n. 18px en mÃ³vil, mÃ¡x. 24px en escritorio. Cambia ambos valores para ajustar el rango */
  font-weight:700;
  line-height:1.45;
  color:var(--ink);
  margin-bottom:36px;
  animation:fadeUp .4s cubic-bezier(.4,0,.2,1);
}

/* â”€â”€â”€ OPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.options { display:flex; flex-direction:column; gap:10px; }

.opt {
  display:flex; align-items:center; gap:16px;
  padding:18px 20px;
  border:1px solid var(--ink-20);
  background:var(--white);
  cursor:pointer;
  transition:border-color .2s, background .2s, transform .15s;
  animation:slideIn .35s cubic-bezier(.4,0,.2,1) both;
  position:relative; overflow:hidden;
}
.opt::after {
  content:'';
  position:absolute; inset:0;
  background:var(--ink);
  opacity:0;
  transition:opacity .2s;
}
.opt:hover:not(.locked) { border-color:var(--ink); transform:translateX(4px); }
.opt:hover:not(.locked)::after { opacity:.03; }

.opt:nth-child(1) { animation-delay:.04s; }
.opt:nth-child(2) { animation-delay:.08s; }
.opt:nth-child(3) { animation-delay:.12s; }
.opt:nth-child(4) { animation-delay:.16s; }

@keyframes slideIn {
  from { opacity:0; transform:translateX(-16px); }
  to   { opacity:1; transform:translateX(0); }
}

.opt.locked { cursor:default; }

.opt.opt-correct {
  border-color:var(--emerald);
  background:#f0faf5;
  animation:popIn .4s cubic-bezier(.34,1.56,.64,1);
}
.opt.opt-wrong {
  border-color:var(--ruby);
  background:#fdf0f0;
  animation:shake .4s ease;
}

.opt-letter {
  width:32px; height:32px;
  border:1px solid var(--ink-20);
  display:flex; align-items:center; justify-content:center;
  font-family:'DM Mono', monospace;
  font-size:12px; /* âœï¸ TAMAÃ‘O: letra de opciÃ³n (A / B / C / D) en el cuadro de cada respuesta â€” recomendado: 11pxâ€“14px */
  font-weight:500;
  color:var(--ink-60);
  flex-shrink:0;
  transition:all .2s;
}
.opt-correct .opt-letter { background:var(--emerald); border-color:var(--emerald); color:var(--white); }
.opt-wrong   .opt-letter { background:var(--ruby);    border-color:var(--ruby);    color:var(--white); }

.opt-text {
  flex:1; font-size:15px; /* âœï¸ TAMAÃ‘O: texto de cada opciÃ³n de respuesta â€” recomendado: 14pxâ€“17px */
  line-height:1.5;
  color:var(--ink); transition:color .2s;
}

.opt-badge {
  font-size:20px; /* âœï¸ TAMAÃ‘O: emoji âœ“ / âœ• que aparece al seleccionar una opciÃ³n â€” recomendado: 18pxâ€“24px */
  flex-shrink:0;
  opacity:0; transform:scale(0);
  transition:all .3s cubic-bezier(.34,1.56,.64,1);
}
.opt-correct .opt-badge, .opt-wrong .opt-badge { opacity:1; transform:scale(1); }

/* â”€â”€â”€ FEEDBACK CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feedback {
  margin-top:24px;
  padding:24px 28px;
  border-left:3px solid var(--gold);
  background:var(--cream);
  animation:fadeUp .4s cubic-bezier(.4,0,.2,1);
  display:none;
}
.feedback.show { display:block; }
.feedback-head {
  font-family:'Playfair Display', serif;
  font-size:17px; /* âœï¸ TAMAÃ‘O: encabezado del feedback (ej. "Â¡Correcto! Excelente dominioâ€¦") â€” recomendado: 15pxâ€“20px */
  font-weight:700;
  margin-bottom:10px;
}
.feedback.fb-correct { border-color:var(--emerald); }
.feedback.fb-wrong   { border-color:var(--ruby); }
.feedback.fb-timeout { border-color:var(--amber); }
.feedback.fb-correct .feedback-head { color:var(--emerald); }
.feedback.fb-wrong   .feedback-head { color:var(--ruby); }
.feedback.fb-timeout .feedback-head { color:var(--amber); }
.feedback-body { font-size:14px; /* âœï¸ TAMAÃ‘O: cuerpo del feedback (respuesta correcta cuando falla) â€” recomendado: 13pxâ€“16px */ line-height:1.75; color:var(--ink-60); }
.feedback-exp {
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid var(--ink-20);
  font-size:13px; /* âœï¸ TAMAÃ‘O: texto de explicaciÃ³n de la respuesta en cursiva â€” recomendado: 12pxâ€“15px */
  line-height:1.7;
  color:var(--ink); font-style:italic;
}

.next-btn-wrap { margin-top:20px; text-align:right; }

/* â”€â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.results-hero {
  text-align:center;
  padding-bottom:40px;
  border-bottom:1px solid var(--ink-20);
  margin-bottom:40px;
  position:relative;
}
.results-hero::after {
  content:'';
  position:absolute; bottom:-1px; left:50%; transform:translateX(-50%);
  width:60px; height:2px; background:var(--gold);
}

.result-grade {
  font-family:'Playfair Display', serif;
  font-size:clamp(80px,15vw,120px); /* âœï¸ TAMAÃ‘O: letra de calificaciÃ³n gigante (A/B/C/D/F) en resultados â€” mÃ­n. 80px mÃ³vil, mÃ¡x. 120px escritorio */
  font-weight:900;
  line-height:1;
  letter-spacing:-4px;
  margin:16px 0;
  background: linear-gradient(135deg, var(--gold) 0%, #8b6914 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  animation: gradeIn .6s cubic-bezier(.34,1.56,.64,1);
}
@keyframes gradeIn {
  from { opacity:0; transform:scale(.5) rotate(-10deg); }
  to   { opacity:1; transform:scale(1) rotate(0deg); }
}

.grade-badge-F { background:linear-gradient(135deg, var(--ruby),  #7f1d1d) !important; }
.grade-badge-D { background:linear-gradient(135deg, #d97706,      #92400e) !important; }
.grade-badge-C { background:linear-gradient(135deg, var(--amber),  #78350f) !important; }
.grade-badge-B { background:linear-gradient(135deg, var(--sapphire),#1e3a5f) !important; }
.grade-badge-A { background:linear-gradient(135deg, var(--gold),   #8b6914) !important; }

.result-msg {
  font-family:'Playfair Display', serif;
  font-size:20px; /* âœï¸ TAMAÃ‘O: mensaje principal de resultados (ej. "Â¡Dominio sobresaliente!") â€” recomendado: 17pxâ€“24px */
  font-style:italic;
  color:var(--ink-60);
  margin-bottom:6px;
}
.result-sub { font-size:14px; /* âœï¸ TAMAÃ‘O: descripciÃ³n debajo del mensaje de resultados â€” recomendado: 13pxâ€“16px */ color:var(--ink-60); max-width:460px; margin:0 auto; line-height:1.6; }

/* Stats row */
.stats-row {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:1px;
  background:var(--ink-20);
  border:1px solid var(--ink-20);
  margin-bottom:40px;
}
.stat-cell {
  background:var(--white);
  padding:28px 20px;
  text-align:center;
  animation:fadeUp .4s ease both;
}
.stat-cell:nth-child(2) { animation-delay:.1s; }
.stat-cell:nth-child(3) { animation-delay:.2s; }
.stat-num {
  font-family:'Playfair Display', serif;
  font-size:clamp(32px,5vw,48px); /* âœï¸ TAMAÃ‘O: nÃºmeros grandes de estadÃ­sticas (porcentaje, correctas, incorrectas) â€” mÃ­n. 32px mÃ³vil, mÃ¡x. 48px escritorio */
  font-weight:900;
  color:var(--ink);
  display:block;
  line-height:1;
  margin-bottom:8px;
}
.stat-label {
  font-size:11px; /* âœï¸ TAMAÃ‘O: etiquetas de las estadÃ­sticas ("Porcentaje", "Correctas", "Incorrectas") â€” recomendado: 10pxâ€“13px */
  letter-spacing:2px; text-transform:uppercase;
  color:var(--ink-60); font-weight:500;
  font-family:'DM Mono', monospace;
}

/* Score bar */
.score-viz {
  margin-bottom:36px;
}
.score-viz-label {
  display:flex; justify-content:space-between;
  font-size:12px; /* âœï¸ TAMAÃ‘O: etiquetas "0%" / "Resultado" / "100%" sobre la barra de puntaje â€” recomendado: 11pxâ€“14px */
  color:var(--ink-60);
  margin-bottom:8px; font-family:'DM Mono', monospace;
}
.score-viz-track {
  height:8px; background:var(--ink-20);
  position:relative;
}
.score-viz-fill {
  position:absolute; top:0; left:0;
  height:100%; background:var(--gold);
  width:0;
  transition:width 1.2s cubic-bezier(.4,0,.2,1) .4s;
}

/* Review list */
.review-header {
  font-family:'DM Mono', monospace;
  font-size:10px; /* âœï¸ TAMAÃ‘O: tÃ­tulo "RevisiÃ³n de respuestas" sobre la lista de revisiÃ³n â€” recomendado: 9pxâ€“12px */
  letter-spacing:2px; text-transform:uppercase;
  color:var(--gold); margin-bottom:20px;
  padding-bottom:12px;
  border-bottom:1px solid var(--ink-20);
}

.review-item {
  padding:20px 0;
  border-bottom:1px solid var(--ink-20);
  animation:fadeUp .3s ease both;
}
.review-row1 {
  display:flex; gap:12px; align-items:flex-start;
  margin-bottom:10px;
}
.review-idx {
  font-family:'DM Mono', monospace;
  font-size:11px; /* âœï¸ TAMAÃ‘O: nÃºmero de pregunta en la revisiÃ³n (ej. "01", "02") â€” recomendado: 10pxâ€“13px */
  color:var(--gold);
  flex-shrink:0; margin-top:3px;
}
.review-q { font-weight:600; font-size:14px; /* âœï¸ TAMAÃ‘O: texto de la pregunta en la secciÃ³n de revisiÃ³n â€” recomendado: 13pxâ€“16px */ line-height:1.5; }
.review-status {
  margin-left:auto; flex-shrink:0;
  font-family:'DM Mono', monospace;
  font-size:10px; /* âœï¸ TAMAÃ‘O: badge "Correcto" / "Incorrecto" en la revisiÃ³n â€” recomendado: 9pxâ€“12px */
  letter-spacing:1px; text-transform:uppercase;
  padding:4px 10px;
  font-weight:600;
}
.review-status.ok  { background:var(--emerald); color:var(--white); }
.review-status.bad { background:var(--ruby);    color:var(--white); }

.review-answers { margin-left:26px; font-size:13px; /* âœï¸ TAMAÃ‘O: texto de respuesta del estudiante y respuesta correcta en revisiÃ³n â€” recomendado: 12pxâ€“15px */ line-height:1.8; color:var(--ink-60); }
.review-answers strong { color:var(--ink); }
.review-exp {
  margin-left:26px;
  margin-top:8px;
  font-size:12px; /* âœï¸ TAMAÃ‘O: explicaciÃ³n en cursiva dentro de cada Ã­tem de revisiÃ³n â€” recomendado: 11pxâ€“14px */
  font-style:italic;
  line-height:1.7;
  color:var(--ink-60);
  padding-top:8px;
  border-top:1px dashed var(--ink-20);
}

/* â”€â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(12px); }
  to   { opacity:1; transform:translateY(0); }
}
@keyframes popIn {
  from { opacity:0; transform:scale(.7); }
  to   { opacity:1; transform:scale(1); }
}
@keyframes shake {
  0%,100% { transform:translateX(0); }
  20%      { transform:translateX(-8px); }
  40%      { transform:translateX(8px); }
  60%      { transform:translateX(-5px); }
  80%      { transform:translateX(5px); }
}
@keyframes panelIn {
  from { opacity:0; transform:translateY(30px) scale(.98); }
  to   { opacity:1; transform:translateY(0)    scale(1); }
}
.panel { animation:panelIn .5s cubic-bezier(.4,0,.2,1); }

/* â”€â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.confetti-bit {
  position:fixed; top:-20px;
  pointer-events:none; z-index:9999;
  animation:confFall linear forwards;
}
@keyframes confFall {
  to { transform:translateY(110vh) rotate(720deg); opacity:0; }
}

/* â”€â”€â”€ HIDDEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hidden { display:none !important; }

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .panel-inner { padding:36px 24px 40px; }
  .rules-grid  { grid-template-columns:1fr; }
  .stats-row   { grid-template-columns:1fr; }
  .btn-row     { flex-direction:column; }
  .result-grade{ font-size:80px; /* âœï¸ TAMAÃ‘O: calificaciÃ³n gigante en pantallas pequeÃ±as (mÃ³vil) â€” recomendado: 60pxâ€“100px */ }
}
</style>
</head>
<body>

<div class="stage">
<div class="panel">
<div class="panel-inner">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 0: INICIO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-start">

    <div class="masthead">
      <span class="eyebrow">ContadurÃ­a PÃºblica Â· AuditorÃ­a II</span>
      <span class="masthead-icon">ğŸ”</span>
      <h1>EvaluaciÃ³n sobre el<br><em>Informe del Auditor</em></h1>
      <p class="masthead-subtitle">Norma Internacional de AuditorÃ­a 700 â€” RevisiÃ³n 2024</p>
    </div>

    <div class="rules">
      <p class="rules-title">CÃ³mo funciona</p>
      <div class="rules-grid">
        <div class="rule-item"><span>ğŸ“‹</span><span>14 preguntas de opciÃ³n mÃºltiple</span></div>
        <div class="rule-item"><span>â±ï¸</span><span>30 segundos por pregunta</span></div>
        <div class="rule-item"><span>ğŸ’¡</span><span>ExplicaciÃ³n inmediata tras cada respuesta</span></div>
        <div class="rule-item"><span>ğŸ“„</span><span>Descarga tus resultados en PDF</span></div>
      </div>
    </div>

    <div class="field">
      <label class="field-label" for="inp-name">Tu nombre completo</label>
      <div class="field-wrap">
        <input
          id="inp-name"
          class="field-input"
          type="text"
          placeholder="Ej. MarÃ­a GarcÃ­a LÃ³pez"
          maxlength="80"
          autocomplete="off"
          spellcheck="false"
          aria-required="true"
        >
        <div class="field-line"></div>
      </div>
      <p class="field-error" id="name-err" role="alert"></p>
    </div>

    <button class="btn-primary" onclick="startQuiz()">
      <span>Comenzar evaluaciÃ³n â†’</span>
    </button>

    <p style="text-align:center;margin-top:20px;font-size:18px;color:var(--ink-60);">
      Mtra. Jaquelina Judith SÃ¡nchez Antele
    </p>

  </div><!-- /s-start -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 1: PREGUNTA
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-quiz" class="hidden">

    <div class="quiz-meta">
      <span class="q-counter" id="qCounter">01 / 14</span>
      <span class="q-user"   id="qUser"></span>
    </div>
    <div class="progress-rail">
      <div class="progress-fill-bar" id="progBar" style="width:0%"></div>
    </div>

    <div class="timer-wrap">
      <div class="timer-ring">
        <svg width="48" height="48" viewBox="0 0 48 48">
          <circle class="track" cx="24" cy="24" r="20"/>
          <circle class="fill"  cx="24" cy="24" r="20" id="timerArc"/>
        </svg>
        <div class="timer-num" id="timerNum">30</div>
      </div>
      <span class="timer-label" id="timerLabel">segundos restantes</span>
      <div class="streak-pill" id="streakPill"></div>
    </div>

    <div id="q-num-label" class="q-num"></div>
    <div class="q-text" id="qText"></div>
    <div class="options" id="opts"></div>
    <div class="feedback" id="feedback">
      <div class="feedback-head" id="fb-head"></div>
      <div class="feedback-body" id="fb-body"></div>
      <div class="feedback-exp"  id="fb-exp"></div>
    </div>
    <div class="next-btn-wrap hidden" id="nextWrap">
      <button class="btn-ghost" onclick="goNext()" id="btnNext">
        <span id="btnNextTxt">Siguiente</span>
        <span>â†’</span>
      </button>
    </div>

  </div><!-- /s-quiz -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PANTALLA 2: RESULTADOS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="s-results" class="hidden">

    <div class="results-hero">
      <span class="eyebrow">EvaluaciÃ³n Completada</span>
      <div class="masthead-icon" id="resIcon">ğŸ†</div>
      <div class="result-grade" id="resGrade"></div>
      <div class="result-msg"   id="resMsg"></div>
      <p   class="result-sub"   id="resSub"></p>
    </div>

    <div class="stats-row">
      <div class="stat-cell">
        <span class="stat-num"  id="sPct"></span>
        <span class="stat-label">Porcentaje</span>
      </div>
      <div class="stat-cell">
        <span class="stat-num"  id="sScore"></span>
        <span class="stat-label">Correctas</span>
      </div>
      <div class="stat-cell">
        <span class="stat-num"  id="sWrong"></span>
        <span class="stat-label">Incorrectas</span>
      </div>
    </div>

    <div class="score-viz">
      <div class="score-viz-label">
        <span>0%</span><span>Resultado</span><span>100%</span>
      </div>
      <div class="score-viz-track">
        <div class="score-viz-fill" id="scoreFill"></div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-ghost" onclick="resetQuiz()">â†© Reintentar</button>
      <button class="btn-emerald" onclick="downloadResults(event)">â¬‡ Descargar PDF</button>
    </div>

    <div style="margin-top:48px;">
      <p class="review-header">RevisiÃ³n de respuestas</p>
      <div id="reviewList"></div>
    </div>

  </div><!-- /s-results -->

</div><!-- /panel-inner -->
</div><!-- /panel -->
</div><!-- /stage -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="console.warn('jsPDF no se cargÃ³')"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" onerror="console.warn('html2canvas no se cargÃ³')"></script>
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SEGURIDAD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function esc(s){
  if(typeof s!=='string') return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}
function validName(n){ return /^[a-zA-ZÃ¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“ÃšÃ¼ÃœÃ±Ã‘\s]{2,80}$/.test(n.trim()); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DATOS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const QS=[
  {q:"Â¿CuÃ¡l es el producto final mÃ¡s importante del trabajo de auditorÃ­a?",
   o:["Los papeles de trabajo","El informe del auditor independiente","El contrato de auditorÃ­a","Las confirmaciones bancarias"],
   c:1, exp:"El informe del auditor independiente es el producto final mÃ¡s importante porque comunica la opiniÃ³n profesional sobre los estados financieros."},
  {q:"SegÃºn NIA 700, Â¿quÃ© elemento debe aparecer PRIMERO en el informe del auditor?",
   o:["Fundamento de la opiniÃ³n","Responsabilidades del auditor","OpiniÃ³n del auditor","TÃ­tulo del informe"],
   c:2, exp:"La NIA 700 revisada establece que la opiniÃ³n debe aparecer primero (tras el tÃ­tulo y destinatario) para darle mayor prominencia."},
  {q:"Â¿CuÃ¡ntos elementos estructurados debe contener el informe del auditor segÃºn NIA 700?",
   o:["10 elementos","13 elementos","15 elementos","8 elementos"],
   c:1, exp:"El informe del auditor debe contener 13 elementos estructurados segÃºn la NIA 700."},
  {q:"Â¿QuÃ© tipo de opiniÃ³n emite el auditor cuando los estados financieros estÃ¡n correctos en todos aspectos materiales?",
   o:["OpiniÃ³n con salvedades","OpiniÃ³n adversa","OpiniÃ³n sin salvedades","AbstenciÃ³n de opiniÃ³n"],
   c:2, exp:"La opiniÃ³n sin salvedades (limpia) se emite cuando los estados financieros no presentan errores materiales."},
  {q:"Â¿QuiÃ©n es responsable de la preparaciÃ³n de los estados financieros?",
   o:["El auditor externo","Los accionistas","La administraciÃ³n de la entidad","El gobierno corporativo"],
   c:2, exp:"La administraciÃ³n es responsable de preparar y presentar razonablemente los estados financieros."},
  {q:"El escepticismo profesional significa que el auditor debe:",
   o:["Desconfiar siempre de la administraciÃ³n","Mantener una actitud cuestionadora y evaluar crÃ­ticamente la evidencia","Aceptar toda la informaciÃ³n proporcionada","Sospechar de fraude en todas las auditorÃ­as"],
   c:1, exp:"El escepticismo profesional implica una actitud cuestionadora que incluye evaluar crÃ­ticamente la evidencia, sin aceptar todo sin verificaciÃ³n."},
  {q:"La fecha del informe del auditor NO debe ser anterior a:",
   o:["La fecha de cierre del ejercicio","La fecha en que obtuvo evidencia suficiente y apropiada","La fecha de la junta de accionistas","La fecha del contrato de auditorÃ­a"],
   c:1, exp:"La fecha del informe no puede ser anterior a cuando el auditor obtuvo evidencia suficiente y apropiada que sustenta su opiniÃ³n."},
  {q:"Â¿QuÃ© frase utiliza el auditor en una opiniÃ³n con salvedades?",
   o:["En nuestra opiniÃ³n adversa","Nos abstenemos de opinar","Excepto por o Salvo por","Sin ninguna salvedad"],
   c:2, exp:"La opiniÃ³n con salvedades usa obligatoriamente la expresiÃ³n 'excepto por' o 'salvo por' para seÃ±alar el problema especÃ­fico."},
  {q:"Las Cuestiones Clave de AuditorÃ­a se incluyen obligatoriamente en informes de:",
   o:["Todas las entidades sin excepciÃ³n","Solo entidades pequeÃ±as","Entidades cotizadas en bolsa","Entidades sin fines de lucro"],
   c:2, exp:"Las Cuestiones Clave de AuditorÃ­a son obligatorias para auditorÃ­as de entidades cotizadas en bolsa."},
  {q:"Â¿QuÃ© nivel de seguridad proporciona una auditorÃ­a?",
   o:["Seguridad absoluta","Seguridad razonable","Seguridad limitada","Seguridad total"],
   c:1, exp:"La auditorÃ­a proporciona seguridad razonable (alta pero no absoluta) de que los estados financieros estÃ¡n libres de error material."},
  {q:"Â¿CuÃ¡l NO es un tipo de usuario de la informaciÃ³n financiera?",
   o:["Inversionistas","Acreedores","Competidores","El propio auditor"],
   c:3, exp:"El auditor examina los estados financieros pero no es un usuario de la informaciÃ³n financiera; los usuarios son quienes toman decisiones basÃ¡ndose en ella."},
  {q:"La opiniÃ³n adversa se emite cuando:",
   o:["Hay errores menores no materiales","El auditor no pudo obtener evidencia","Los estados financieros tienen errores materiales y generalizados","Existe una salvedad especÃ­fica"],
   c:2, exp:"La opiniÃ³n adversa indica que los estados financieros tienen errores tan graves y generalizados que no son confiables."},
  {q:"Â¿QuÃ© debe incluir el tÃ­tulo del informe segÃºn NIA 700?",
   o:["La palabra 'Certificado'","La palabra 'Independiente'","La palabra 'Oficial'","La palabra 'Definitivo'"],
   c:1, exp:"El tÃ­tulo debe incluir la palabra 'independiente' para distinguirlo de otros informes (ej: 'Informe del Auditor Independiente')."},
  {q:"La materialidad se refiere a:",
   o:["La cantidad de papeles de trabajo","La importancia de los activos tangibles","La magnitud de error que podrÃ­a influir en decisiones de usuarios","El tiempo que toma la auditorÃ­a"],
   c:2, exp:"La materialidad es el umbral que determina si un error es lo suficientemente importante como para influir en las decisiones de los usuarios."}
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ESTADO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let cur=0, answers={}, userName='', streak=0, timerInt=null, timeLeft=30;
const TOTAL_TIME=30;
const CIRC=125.6; // 2Ï€ Ã— 20

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STORAGE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveSession(){
  const session={cur,answers,userName,streak,timestamp:Date.now()};
  try{ localStorage.setItem('quizSession',JSON.stringify(session)); }catch(e){}
}

function loadSession(){
  try{ const s=JSON.parse(localStorage.getItem('quizSession')||'null'); return s && s.timestamp && (Date.now()-s.timestamp)<86400000 ? s : null; }catch(e){ return null; }
}

function clearSession(){
  try{ localStorage.removeItem('quizSession'); }catch(e){}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INICIO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startQuiz(){
  const inp=document.getElementById('inp-name');
  const err=document.getElementById('name-err');
  const raw=inp.value.trim();
  inp.classList.remove('err'); err.classList.remove('show');

  if(!raw){ return showErr(inp,err,'Por favor ingresa tu nombre para continuar.'); }
  if(!validName(raw)){ return showErr(inp,err,'Solo se permiten letras y espacios (2â€“80 caracteres).'); }

  userName=esc(raw);
  cur=0; answers={}; streak=0;
  saveSession();

  show('s-quiz');
  document.getElementById('qUser').textContent=userName;
  loadQ();
}

function showErr(inp,err,msg){
  inp.classList.add('err');
  err.textContent=msg; err.classList.add('show');
  inp.focus();
  setTimeout(()=>inp.classList.remove('err'),600);
}

document.getElementById('inp-name').addEventListener('keydown',e=>{ if(e.key==='Enter') startQuiz(); });

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INICIALIZACIÃ“N
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener('DOMContentLoaded',()=>{
  const saved=loadSession();
  if(saved && saved.userName){
    const recoveryBtn=document.createElement('div');
    recoveryBtn.style.cssText='position:fixed;bottom:20px;right:20px;z-index:999;background:#0f7b52;color:#fff;padding:14px 20px;border-radius:4px;cursor:pointer;font-size:13px;max-width:200px;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
    recoveryBtn.innerHTML='ğŸ“‹ SesiÃ³n anterior detectada. <a href=\"#\" style=\"color:#ffd700;text-decoration:underline;\" onclick=\"recoverSession(event)\">Recuperar</a>';
    document.body.appendChild(recoveryBtn);
  }
});

function recoverSession(e){
  e.preventDefault();
  const saved=loadSession();
  if(!saved) return alert('No hay sesiÃ³n guardada.');
  Object.assign({cur,answers,userName,streak},{cur:saved.cur,answers:saved.answers,userName:saved.userName,streak:saved.streak});
  document.getElementById('inp-name').value=saved.userName;
  cur=saved.cur; answers=saved.answers; userName=saved.userName; streak=saved.streak;
  show('s-quiz');
  document.getElementById('qUser').textContent=userName;
  loadQ();
  document.querySelectorAll('[style*="fixed"][style*="bottom"]').forEach(el=>el.remove());
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TIMER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startTimer(){
  clearInterval(timerInt);
  timeLeft=TOTAL_TIME;
  tickTimer();
  timerInt=setInterval(()=>{ timeLeft--; tickTimer(); if(timeLeft<=0){ clearInterval(timerInt); timeoutQ(); } },1000);
}

function tickTimer(){
  const num=document.getElementById('timerNum');
  const arc=document.getElementById('timerArc');
  const lbl=document.getElementById('timerLabel');
  num.textContent=timeLeft;
  const offset=CIRC*(1-timeLeft/TOTAL_TIME);
  arc.style.strokeDashoffset=offset;
  arc.className='fill';
  if(timeLeft<=10) arc.classList.add('warn');
  if(timeLeft<=5)  arc.classList.add('danger');
  lbl.textContent=timeLeft===1?'segundo restante':'segundos restantes';
}

function stopTimer(){ clearInterval(timerInt); }

function timeoutQ(){
  if(answers[cur]!==undefined) return;
  answers[cur]=-1; streak=0;
  lockOptions(QS[cur].correct,-1);
  showFeedback(false, true, QS[cur]);
  revealNext();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PREGUNTA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadQ(){
  const q=QS[cur];
  const total=QS.length;
  const pct=Math.round((cur/total)*100);

  document.getElementById('qCounter').textContent=`${String(cur+1).padStart(2,'0')} / ${total}`;
  document.getElementById('progBar').style.width=pct+'%';
  document.getElementById('q-num-label').textContent=`Pregunta ${cur+1} de ${total}`;
  document.getElementById('qText').textContent=q.q;

  // Re-animar texto
  const qt=document.getElementById('qText');
  qt.style.animation='none'; qt.offsetHeight; qt.style.animation='';

  // Opciones
  const container=document.getElementById('opts');
  container.innerHTML='';
  q.o.forEach((txt,i)=>{
    const d=document.createElement('div');
    d.className='opt';
    d.setAttribute('role','button'); d.setAttribute('tabindex','0');
    d.innerHTML=`
      <div class="opt-letter">${String.fromCharCode(65+i)}</div>
      <div class="opt-text">${esc(txt)}</div>
      <div class="opt-badge"></div>
    `;
    d.onclick=()=>pick(i);
    d.onkeydown=e=>{ if(e.key==='Enter'||e.key===' ') pick(i); };
    container.appendChild(d);
  });

  // Reset feedback
  const fb=document.getElementById('feedback');
  fb.className='feedback'; fb.classList.remove('show');
  document.getElementById('nextWrap').classList.add('hidden');

  // Racha
  const sp=document.getElementById('streakPill');
  if(streak>=2){ sp.textContent=`ğŸ”¥ Ã—${streak}`; sp.classList.add('visible'); }
  else { sp.classList.remove('visible'); }

  startTimer();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESPUESTA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pick(idx){
  if(answers[cur]!==undefined) return;
  stopTimer();
  answers[cur]=idx;
  const q=QS[cur];
  const ok=(idx===q.c);
  if(ok) streak++; else streak=0;
  saveSession();
  lockOptions(q.c, idx);
  showFeedback(ok, false, q);
  revealNext();
}

function lockOptions(correctIdx, chosenIdx){
  document.querySelectorAll('.opt').forEach((el,i)=>{
    el.classList.add('locked');
    el.onclick=null; el.onkeydown=null;
    el.setAttribute('tabindex','-1');
    const badge=el.querySelector('.opt-badge');
    if(i===correctIdx){
      el.classList.add('opt-correct');
      badge.textContent='âœ“';
    } else if(i===chosenIdx && chosenIdx!==correctIdx){
      el.classList.add('opt-wrong');
      badge.textContent='âœ•';
    }
  });
}

function showFeedback(ok, timeout, q){
  const fb=document.getElementById('feedback');
  const head=document.getElementById('fb-head');
  const body=document.getElementById('fb-body');
  const exp =document.getElementById('fb-exp');

  const okMsgs=['Â¡Correcto! Excelente dominio del tema.','Â¡Perfecto! Eso es auditorÃ­a.','Â¡Muy bien! Sigues en racha.','Â¡Acertaste! Conoces la NIA 700.'];
  const badMsgs=['Respuesta incorrecta. Revisa la explicaciÃ³n.','No es la opciÃ³n correcta. Â¡A repasar!','Casi. Presta atenciÃ³n a la explicaciÃ³n.','Incorrecto, pero asÃ­ se aprende. ğŸ’ª'];

  if(timeout){
    fb.className='feedback fb-timeout show';
    head.textContent='â° Tiempo agotado';
    body.textContent='No respondiste a tiempo. La respuesta correcta estÃ¡ marcada en verde.';
  } else if(ok){
    fb.className='feedback fb-correct show';
    head.textContent=okMsgs[Math.floor(Math.random()*okMsgs.length)];
    body.textContent='';
  } else {
    fb.className='feedback fb-wrong show';
    head.textContent=badMsgs[Math.floor(Math.random()*badMsgs.length)];
    body.textContent=`Respuesta correcta: ${esc(q.o[q.c])}`;
  }
  exp.textContent=q.exp;
}

function revealNext(){
  const wrap=document.getElementById('nextWrap');
  wrap.classList.remove('hidden');
  const lbl=document.getElementById('btnNextTxt');
  lbl.textContent=(cur<QS.length-1)?'Siguiente':'Ver resultados';
  document.getElementById('btnNext').focus();
}

function goNext(){
  if(cur<QS.length-1){ cur++; saveSession(); loadQ(); }
  else showResults();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESULTADOS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcScore(){ return QS.reduce((a,q,i)=>a+(answers[i]===q.c?1:0),0); }

function getGrade(pct){
  if(pct>=90) return {g:'A',icon:'ğŸ†',msg:'Â¡Dominio sobresaliente!',sub:'Tu comprensiÃ³n de la NIA 700 es de nivel profesional. Excelente trabajo.',cls:'grade-badge-A'};
  if(pct>=80) return {g:'B',icon:'ğŸ¥ˆ',msg:'Â¡Muy buen desempeÃ±o!',   sub:'Tienes un sÃ³lido conocimiento de la NIA 700. Repasa un par de conceptos.',cls:'grade-badge-B'};
  if(pct>=70) return {g:'C',icon:'ğŸ—ï¸',msg:'Resultado aceptable.',    sub:'Vas bien encaminado. Dedica mÃ¡s tiempo a los tipos de opiniÃ³n del auditor.',cls:'grade-badge-C'};
  if(pct>=60) return {g:'D',icon:'ğŸ“š',msg:'Necesitas repasar.',      sub:'Repasa los elementos del informe segÃºn NIA 700 antes de tu prÃ³ximo examen.',cls:'grade-badge-D'};
  return              {g:'F',icon:'ğŸ“–',msg:'Oportunidad de mejora.',  sub:'No te rindas. Revisa el material completo e intenta de nuevo. Â¡TÃº puedes!',cls:'grade-badge-F'};
}

function showResults(){
  stopTimer();
  const score=calcScore();
  const pct=((score/QS.length)*100).toFixed(1);
  const info=getGrade(parseFloat(pct));

  document.getElementById('resIcon').textContent=info.icon;
  const gradeEl=document.getElementById('resGrade');
  gradeEl.textContent=info.g;
  gradeEl.className='result-grade '+info.cls;
  document.getElementById('resMsg').textContent=info.msg;
  document.getElementById('resSub').textContent=info.sub;

  document.getElementById('sPct').textContent=pct+'%';
  document.getElementById('sScore').textContent=score+'/'+QS.length;
  document.getElementById('sWrong').textContent=(QS.length-score)+'/'+QS.length;

  show('s-results');

  // Animar barra
  requestAnimationFrame(()=>{
    setTimeout(()=>{ document.getElementById('scoreFill').style.width=pct+'%'; },100);
  });

  // Confetti si aprueba
  if(parseFloat(pct)>=60) setTimeout(launchConfetti, 300);

  // RevisiÃ³n
  const list=document.getElementById('reviewList');
  list.innerHTML='';
  QS.forEach((q,i)=>{
    const ua=answers[i];
    const ok=(ua===q.c);
    const uTxt=(ua===-1||ua===undefined)?'Sin respuesta (tiempo agotado)':esc(q.o[ua]);
    const div=document.createElement('div');
    div.className='review-item';
    div.style.animationDelay=(i*.04)+'s';
    div.innerHTML=`
      <div class="review-row1">
        <span class="review-idx">${String(i+1).padStart(2,'0')}</span>
        <span class="review-q">${esc(q.q)}</span>
        <span class="review-status ${ok?'ok':'bad'}">${ok?'Correcto':'Incorrecto'}</span>
      </div>
      <div class="review-answers">
        <strong>Tu respuesta:</strong> ${uTxt}
        ${!ok?`<br><strong style="color:var(--emerald)">Correcta:</strong> ${esc(q.o[q.c])}`:''}
      </div>
      <div class="review-exp">${esc(q.exp)}</div>
    `;
    list.appendChild(div);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetQuiz(){
  if(!confirm('Â¿Deseas comenzar una nueva evaluaciÃ³n? Tu progreso se perderÃ¡.')) return;
  stopTimer();
  cur=0; answers={}; userName=''; streak=0;
  clearSession();
  document.getElementById('inp-name').value='';
  document.getElementById('name-err').classList.remove('show');
  show('s-start');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SCREEN SWITCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function show(id){
  ['s-start','s-quiz','s-results'].forEach(s=>{
    const el=document.getElementById(s);
    el.classList.toggle('hidden',s!==id);
  });
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONFETTI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function launchConfetti(){
  const palette=['#c9a84c','#0f7b52','#1a5f9e','#0d0d0d','#faf7f0','#c0392b'];
  for(let i=0;i<80;i++){
    const el=document.createElement('div');
    el.className='confetti-bit';
    const sz=Math.random()*10+5;
    el.style.cssText=`
      left:${Math.random()*100}vw;
      width:${sz}px; height:${sz}px;
      background:${palette[Math.floor(Math.random()*palette.length)]};
      border-radius:${Math.random()>.5?'50%':'2px'};
      animation-duration:${Math.random()*2+1.5}s;
      animation-delay:${Math.random()*1}s;
      opacity:1;
    `;
    document.body.appendChild(el);
    el.addEventListener('animationend',()=>el.remove());
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PDF
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function downloadResults(evt){
  if(!window.jspdf || !window.html2canvas){
    alert('Las librerÃ­as de PDF no se cargaron correctamente. Por favor, intenta de nuevo o revisa tu conexiÃ³n a Internet.');
    return;
  }
  const btn=evt.currentTarget;
  const score=calcScore();
  const pct=((score/QS.length)*100).toFixed(1);
  const info=getGrade(parseFloat(pct));
  const orig=btn.textContent;
  btn.textContent='â³ Generandoâ€¦'; btn.disabled=true;

  const wrap=document.createElement('div');
  wrap.style.cssText='position:absolute;left:-9999px;width:750px;background:#fff;padding:40px;font-family:Georgia,serif;';

  const gradeColorMap={'grade-badge-A':'#c9a84c','grade-badge-B':'#1a5f9e','grade-badge-C':'#d97706','grade-badge-D':'#d97706','grade-badge-F':'#c0392b'};
  const gc=gradeColorMap[info.cls]||'#333';

  let html=`
    <div style="text-align:center;border-bottom:3px solid #c9a84c;padding-bottom:20px;margin-bottom:30px;">
      <p style="font-size:11px;letter-spacing:3px;color:#c9a84c;text-transform:uppercase;margin-bottom:12px;">ContadurÃ­a PÃºblica Â· AuditorÃ­a II</p>
      <h1 style="font-size:28px;color:#0d0d0d;margin:0 0 6px;">Informe del Auditor â€” NIA 700</h1>
      <p style="color:#666;font-size:14px;">EvaluaciÃ³n de competencias Â· ${new Date().toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric'})}</p>
    </div>
    <div style="background:#faf7f0;padding:24px;margin-bottom:28px;border:1px solid #e5e0d0;">
      <p style="font-size:13px;color:#666;margin-bottom:4px;">Estudiante</p>
      <h2 style="font-size:22px;margin:0 0 16px;color:#0d0d0d;">${esc(userName)}</h2>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
        <div style="background:#fff;padding:16px;text-align:center;border:1px solid #e5e0d0;">
          <div style="font-size:11px;color:#999;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;">CalificaciÃ³n</div>
          <div style="font-size:42px;font-weight:bold;color:${gc};">${esc(info.g)}</div>
          <div style="font-size:12px;color:#666;">${esc(info.msg)}</div>
        </div>
        <div style="background:#fff;padding:16px;text-align:center;border:1px solid #e5e0d0;">
          <div style="font-size:11px;color:#999;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;">Porcentaje</div>
          <div style="font-size:42px;font-weight:bold;color:#c9a84c;">${pct}%</div>
          <div style="font-size:12px;color:#666;">De 100%</div>
        </div>
        <div style="background:#fff;padding:16px;text-align:center;border:1px solid #e5e0d0;">
          <div style="font-size:11px;color:#999;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;">Correctas</div>
          <div style="font-size:42px;font-weight:bold;color:#0f7b52;">${score}</div>
          <div style="font-size:12px;color:#666;">De ${QS.length}</div>
        </div>
      </div>
    </div>
    <h3 style="font-size:13px;letter-spacing:2px;text-transform:uppercase;color:#c9a84c;border-bottom:2px solid #c9a84c;padding-bottom:8px;margin-bottom:20px;">Detalle de Respuestas</h3>
  `;

  QS.forEach((q,i)=>{
    const ua=answers[i];
    const ok=(ua===q.c);
    const uTxt=(ua===-1||ua===undefined)?'Sin respuesta':q.o[ua];
    html+=`
      <div style="margin-bottom:16px;padding:14px;border-left:3px solid ${ok?'#0f7b52':'#c0392b'};background:${ok?'#f0faf5':'#fdf0f0'};break-inside:avoid;page-break-inside:avoid;">
        <div style="font-weight:bold;font-size:13px;margin-bottom:8px;">
          ${ok?'âœ“':'âœ—'} ${i+1}. ${esc(q.q)}
        </div>
        <div style="font-size:12px;color:#555;margin-left:18px;line-height:1.6;">
          <strong>Respuesta:</strong> ${esc(uTxt)}<br>
          ${!ok?`<strong style="color:#0f7b52">Correcta:</strong> ${esc(q.o[q.c])}<br>`:''}
          <em style="color:#888;font-size:11px;">${esc(q.exp)}</em>
        </div>
      </div>
    `;
  });

  html+=`
    <div style="text-align:center;margin-top:40px;padding-top:16px;border-top:1px solid #e5e0d0;color:#999;font-size:11px;">
      Mtra. Jaquelina Judith SÃ¡nchez Antele Â· AuditorÃ­a II Â· NIA 700
    </div>
  `;

  wrap.innerHTML=html;
  document.body.appendChild(wrap);

  setTimeout(()=>{
    html2canvas(wrap,{scale:2,useCORS:true,logging:false,backgroundColor:'#fff',windowWidth:750}).then(canvas=>{
      const imgData=canvas.toDataURL('image/png');
      const {jsPDF}=window.jspdf;
      const pdf=new jsPDF('p','mm','letter');
      const W=215.9,H=279.4,M=12,cW=W-M*2,cH=H-M*2;
      const iW=cW, iH=(canvas.height*cW)/canvas.width;
      let left=iH, pos=M;
      pdf.addImage(imgData,'PNG',M,pos,iW,iH);
      left-=cH;
      while(left>0){
        pos=M-(iH-left);
        pdf.addPage();
        pdf.addImage(imgData,'PNG',M,pos,iW,iH);
        left-=cH;
      }
      const safeName=userName.replace(/[^a-zA-Z0-9]/g,'_').substring(0,40);
      const dateStr=new Date().toLocaleDateString('es-MX').replace(/\//g,'-');
      pdf.save(`NIA700_${safeName}_${dateStr}.pdf`);
      document.body.removeChild(wrap);
      btn.textContent=orig; btn.disabled=false;
    }).catch(()=>{
      document.body.removeChild(wrap);
      btn.textContent=orig; btn.disabled=false;
      alert('Error al generar el PDF. Por favor intenta de nuevo.');
    });
  },150);
}
</script>
</body>
</html>